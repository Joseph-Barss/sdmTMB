---
title: "Visualization Options with visreg and ggeffects"
author: "Julia Indivero, Sean Anderson, Lewis Barnett, Philina English, Eric Ward"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Visualization Options with visreg and ggeffects}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE, cache=FALSE}
dplyr_installed <- require("dplyr", quietly = TRUE)
ggplot_installed <- require("ggplot2", quietly = TRUE)
ggeffects_installed <- require("ggeffects", quietly=TRUE)
prediction_installed <- require("prediction", quietly=TRUE)
pkgs <- dplyr_installed && ggplot_installed &&visreg_installed && ggeffects_installed

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.asp = 0.618,
  eval = identical(Sys.getenv("NOT_CRAN"), "true") && pkgs
)
```

The package [ggeffects]https://cran.r-project.org/web/packages/ggeffects/index.html. can similarly be used to plot marginal effects from an `sdmTMB` model

First, switch to the 'dev' branch of sdmTMB (for now anyway)
```{r}
remove.packages("sdmTMB")
remotes::install_github("pbs-assess/sdmTMB", ref = "dev")

# or restart your R session some other way...
rstudioapi::restartSession()

install.packages("prediction")
library(prediction)
library(sdmTMB)
library(ggeffects)

```


```{r}
fit <- sdmTMB(present ~poly(depth,2)+fyear,
       #present~depth,
       data=pcod_2011, mesh=pcod_mesh_2011,
       spatial="off",
       family=binomial()
       )

g <- ggeffect(fit, "depth [0:500 by=1]")
plot(g)
```

```{r}

g2 <- ggeffect(fit, "fyear")
plot(g2)     
```
 
```{r}
pcod_2011$fyear <- as.factor(pcod_2011$year)
fit3 <- sdmTMB(density ~poly(depth,2)+fyear,
       #present~depth,
       data=pcod_2011, mesh=pcod_mesh_2011,
       spatial="off",
       family=tweedie()
       )

g <- ggeffect(fit3, "depth [0:500 by=1]")
plot(g)
g2 <- ggeffect(fit,"depth [0:500 by=1]", )
ggplot(g, aes(x, predicted, color=fyear))+geom_line()
```



```{r}
# make fake predictor(s) and sampling locations:
N = 300
predictor_dat <- data.frame(
  X = runif(N), Y = runif(N),
  log_depth = rnorm(N,mean=2,sd=1), 
  year = rep(1:6, each = 50),
  hour = sample(1:24, size = N, replace=T)
)
predictor_dat$hour_effect = 0.2 * sin(2*pi/365*predictor_dat$hour)
predictor_dat$log_depth2 = predictor_dat$log_depth^2

mesh <- make_mesh(predictor_dat, xy_cols = c("X", "Y"), cutoff = 0.1)

sim_dat <- sdmTMB_simulate(
  formula = ~ hour_effect + log_depth + log_depth2,
  data = predictor_dat,
  time = "year",
  mesh = mesh,
  family = gaussian(),
  range = 0.5,
  sigma_E = 0.1,
  phi = 0.1,
  sigma_O = 0.2,
  seed = 42,
  B = c(0.2, -0.4, 0.02) # hour effect, linear depth, quadratic depth
)

```

