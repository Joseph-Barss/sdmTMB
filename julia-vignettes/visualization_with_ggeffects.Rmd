---
title: "Visualization Options with ggeffects"
author: "Julia Indivero, Sean Anderson, Lewis Barnett, Philina English, Eric Ward"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Visualization Options with ggeffects}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE, cache=FALSE}
dplyr_installed <- require("dplyr", quietly = TRUE)
ggplot_installed <- require("ggplot2", quietly = TRUE)
ggeffects_installed <- require("ggeffects", quietly=TRUE)
prediction_installed <- require("prediction", quietly=TRUE)
sdmTMB_installed <- require("sdmTMB", quietly=TRUE)
pkgs <- dplyr_installed && ggplot_installed && visreg_installed && ggeffects_installed

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.asp = 0.618,
  eval = identical(Sys.getenv("NOT_CRAN"), "true") && pkgs
)
```

The package [ggeffects]https://cran.r-project.org/web/packages/ggeffects/index.html can be used to plot predictions from an `sdmTMB` model while holding certain variables constant, allowing us to see the marginal effects of the other variables (see [this vignette]https://strengejacke.github.io/ggeffects/articles/introduction_marginal_effects.html) for more information.

```{r echo=FALSE, include=FALSE}
#First, switch to the 'dev' branch of sdmTMB (for now anyway)
remove.packages("sdmTMB")
remotes::install_github("pbs-assess/sdmTMB", ref = "dev")

# or restart your R session some other way...
rstudioapi::restartSession()

```

```{r}
library(prediction)
library(sdmTMB)
library(ggeffects)
```

#Example with Pacific cod presence
To start, we will use the Pacific cod data for this example. We will fit a model of fish presence with covariates of depth and a fixed effect of year using a Tweedie distribution.

```{r}
pcod$fyear <- as.factor(pcod$year)
mesh <- make_mesh(pcod, c("X", "Y"), cutoff = 20)
fit <- sdmTMB(present ~poly(depth,2)+fyear,
       data=pcod, 
       mesh=mesh,
       spatial="off",
       family=binomial()
       )
```

We can then use `ggeffect` to see the effect of depth on the probability of Pacific cod being present. We can control what range and interval of depths are predicted within the function (e.g. `[0:500 by=1]`).
```{r}
g <- ggeffect(fit, "depth [0:500 by=1]")
plot(g)
```

We can also plot the effects of each year.
```{r}
g2 <- ggeffect(fit, "fyear")
plot(g2)     
```

We can add in data points
```{r}
plot(g, add.data=TRUE)
```

We can also use `ggeffect` to plot multiple variables by listing variables in `terms=c()`, with the first variable listed indicating the variable to be plotted on the x-axis, and the remaining listed terms (up to four total) indicating the groups. Adding `facet=TRUE` will show each year as a separate plot, instead of overlain on one plot.
```{r}
dat <- ggeffect(fit, terms= c("depth", "fyear"))
plot(dat)
```

Adding `facet=TRUE` will show each year as a separate plot, instead of overlain on one plot.
```{r}
plot(dat, facet=TRUE)
```

We can also use `ggplot` for creating plots by calling the ggeffects object `dat` as the dataframe.
```{r}
ggplot(dat, aes(x, predicted, colour=group))+geom_line()
```

```{r echo=FALSE, include=FALSE}
#With density data? (not currently working--getting error about not being able to find mu.eta)
fit2 <- sdmTMB(density ~depth +fyear,
       data=pcod, 
       mesh=mesh,
       spatial="off",
       family=tweedie()
       )

g2 <- ggeffect(fit2,"depth [0:500 by=1]")
```

```{r echo=FALSE, include=FALSE}
#Is there a way to plot spatial and spatio-temporal variation?
```

#Example using simulated data with multiple continuous explanatory variables
```{r}
# make fake predictor(s) and sampling locations:
N = 300
predictor_dat <- data.frame(
  X = runif(N), Y = runif(N),
  log_depth = rnorm(N,mean=2,sd=1), 
  year = rep(1:6, each = 50),
  hour = sample(1:24, size = N, replace=T)
)
predictor_dat$hour_effect = 0.2 * sin(2*pi/365*predictor_dat$hour)
predictor_dat$log_depth2 = predictor_dat$log_depth^2

mesh <- make_mesh(predictor_dat, xy_cols = c("X", "Y"), cutoff = 0.1)

sim_dat <- sdmTMB_simulate(
  formula = ~ 0 + hour_effect + log_depth + log_depth2,
  data = predictor_dat,
  time = "year",
  mesh = mesh,
  family = gaussian(),
  range = 0.5,
  sigma_E = 0.1,
  phi = 0.1,
  sigma_O = 0.2,
  seed = 42,
  B = c(0.2, -0.4, 0.02) # hour effect, linear depth, quadratic depth
)

```

```{r}
fit3 <- sdmTMB(
       observed ~ 0+hour_effect +log_depth + log_depth2,
       data=sim_dat, 
       mesh=mesh,
       spatial="on",
       time="year",
       family=tweedie()
       )
```

```{r}
g3 <- ggeffect(fit3, "hour_effect")
plot(g)
```


3
```{r}
#Example that has residuals
#plot(g, residuals=T, residuals.line=T)

```

