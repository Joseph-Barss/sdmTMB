---
title: "Visualizing model effects using visreg"
author: "Julia Indivero, Sean Anderson, Lewis Barnett, Philina English, Eric Ward"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Visualization Options with visreg and ggeffects}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}

```{r setup, include = FALSE, cache=FALSE}
dplyr_installed <- require("dplyr", quietly = TRUE)
ggplot_installed <- require("ggplot2", quietly = TRUE)
visreg_installed <- require("visreg", quietly=TRUE)
sdmTMB_installed <- require("sdmTMB", quietly=TRUE)
pkgs <- dplyr_installed && ggplot_installed && visreg_installed && sdmTMB_installed

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.asp = 0.618,
  eval = identical(Sys.getenv("NOT_CRAN"), "true") && pkgs
)
```

```{r echo=FALSE}
library(sdmTMB)
library(ggplot2)
library(visreg)
```

We can use the package [visreg]https://cran.r-project.org/web/packages/visreg/index.html] to visually inspect the model output from `sdmTMB` by comparing the effects of explanatory variables in the model on the response variable.

We will use the Pacific cod biomass for this example. We will fit a model with scaled depth and fixed effect of year using a Tweedie distribution.

```{r}
pcod$fyear <- as.factor(pcod$year)
mesh <- make_mesh(pcod, c("X", "Y"), cutoff = 20)
  fit <- sdmTMB(
    density ~0 + s(depth_scaled) + fyear,
    time="year",
    data=pcod,
    mesh=mesh,
    spatial = "on",
    spatiotemporal="iid",
    family = tweedie(link="log")
  )
```

We can then plot the effect of depth in link space. This shows the value of depth on the x-axis and the change in response on the y-axis, holding all other variables constant.
```{r}
visreg(fit, xvar = "depth_scaled", type="conditional")
```

We also can look at the effect of depth in each year separately, either in separate plots or overlaid on the same plot.
```{r}
visreg(fit, xvar="depth_scaled", by="fyear")
visreg(fit, xvar="depth_scaled", by="fyear", overlay=TRUE)
```

And at the effect of depth in the response scale, rather than link space.
```{r}
visreg(fit, xvar = "depth_scaled", scale = "response")
```

`visreg` can also be used to visualize just the fixed effect of year.
```{r}
visreg(fit, xvar = "fyear")
```

Note that for plotting in `visreg`, categorical variables like year need to be designated as a factor in the dataframe, as in the example above, rather than in the model formula. For instance, while designating year as a character in the dataframe and a factor in the model will work for some models, it will not be able to be plotted in `visreg` for delta models. For this reason, we suggest that it is safer to not use `as.factor` in the model formula.

We can also simultaneously compare both depth and year with a two-dimensional contour plot.
```{r}
visreg2d(fit, xvar = "fyear", yvar = "depth_scaled")
```

`visreg` can also be used to plot the output of delta models from `sdmTMB` by using similar code for the previous `visreg` plots, but specifying `model=1` for the encounter model, and `model=2` for the positive catch rate model. For example,
```{r}
  # Delta model example:
  fit_dg <- sdmTMB(
    density ~ s(depth_scaled, year, k = 8),
    data = pcod_2011, 
    mesh = pcod_mesh_2011,
    spatial = "off",
    family = delta_gamma()
  )

  visreg_delta(fit_dg, xvar = "depth_scaled", model = 1, gg = TRUE)
  visreg_delta(fit_dg, xvar = "depth_scaled", model = 2, gg = TRUE)
```

Partial residuals can be included by setting `partial=TRUE`
```{r}
visreg(fit, xvar = "depth_scaled", type="conditional", partial=TRUE)
```

