---
title: "Calculating range edges"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Calculating range edges}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

**If the code in this vignette has not been evaluated, a rendered version is available on the [documentation site](https://pbs-assess.github.io/sdmTMB/index.html) under 'Articles'.**

```{r setup, include = FALSE, cache=FALSE}
dplyr_installed <- require("dplyr", quietly = TRUE)
ggplot_installed <- require("ggplot2", quietly = TRUE)
pkgs <- dplyr_installed && ggplot_installed
EVAL <- identical(Sys.getenv("NOT_CRAN"), "true") && pkgs
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.asp = 0.618,
  eval = EVAL,
  purl = EVAL
)
```

```{r packages, message=FALSE, warning=TRUE}
library(ggplot2)
library(dplyr)
library(sdmTMB)
```

# Introduction

Range edges are useful metrics for understanding species distributions and how they change over time. The `get_range_edge()` function calculates range edges as density-weighted quantiles along a spatial axis (e.g., latitude, longitude, or depth). This approach follows methods used in Fredston et al. 2021 from VAST.

Range edges are calculated by:

1. Ordering spatial locations along a user-specified axis
2. Calculating the cumulative proportion of total density along that axis
3. Finding positions where the cumulative proportion equals target quantiles
4. Using simulation from the joint precision matrix to quantify uncertainty

In this vignette, we'll demonstrate calculating range edges for Pacific Spiny Dogfish (*Squalus suckleyi*) along the latitude axis on the west coast of Vancouver Island.

# Data

We'll use the built-in `dogfish` dataset, which contains fisheries-independent trawl survey data from the west coast of Vancouver Island. The data includes catch weights, presence/absence, depth, and area swept.

```{r glimpse-dogfish}
glimpse(dogfish)
```

For prediction, we'll use the `wcvi_grid`, which provides a spatial grid covering the survey area:

```{r glimpse-grid}
glimpse(wcvi_grid)
```

# Fitting a spatiotemporal model

First, we'll construct a mesh for the spatial random effects:

```{r mesh, fig.asp=0.8}
mesh <- make_mesh(dogfish, c("X", "Y"), cutoff = 10)
```

Next, we'll fit a spatiotemporal model for dogfish density using a delta generalized-gamma family (Dunic et al. 2025). This models the positive catches with a generalized gamma distribution that works well for Pacific Dogfish given their occasional giant outlying catch values. A simpler Tweedie or delta-gamma family could have been used too. We'll include depth as a predictor using a quadratic effect:

```{r fit-model}
fit <- sdmTMB(
  catch_weight ~ poly(log(depth), 2),
  data = dogfish,
  mesh = mesh,
  family = delta_gengamma(type = "poisson-link"),
  spatial = "on",
  time = "year",
  spatiotemporal = "IID"
)
sanity(fit)
fit
```

The model shows both spatial and spatiotemporal variation, with depth having a strong relationship with dogfish density.

# Making predictions

To calculate range edges, we need to make predictions on a spatial grid that covers the area of interest. We'll replicate the `wcvi_grid` for each year in the dataset and generate predictions with simulation:

```{r predict}
# Create prediction grid for each year
years <- sort(unique(dogfish$year))
nd <- replicate_df(wcvi_grid, "year", years)

# Make predictions with simulations for uncertainty quantification
# Using nsim = 200 simulations from the joint precision matrix
# larger simulations will be more stable at the expense of speed and memory
set.seed(123)
pred <- predict(fit, newdata = nd, nsim = 200)
```

The `predict()` function with `nsim > 0` returns a matrix where each column represents one simulation draw from the joint precision matrix.

# Calculating range edges

Now we can calculate range edges along the latitude axis (Y coordinate). By default, `get_range_edge()` calculates the 2.5% and 97.5% quantiles, representing the lower and upper range edges. Here, we'll also add in the median (0.5) to find the center of the distribution.

```{r range-edges}
edges <- get_range_edge(pred, axis = nd$Y, quantiles = c(0.025, 0.50, 0.975))
head(edges)
```

The output includes:

- `year`: the time slice
- `quantile`: the quantile value (0.025 for lower edge, 0.500 for the median, 0.975 for upper edge)
- `est`: the estimated position along the axis (latitude in this case)
- `lwr` and `upr`: 95% confidence intervals for each quantile
- `se`: standard error for each quantile

# Visualizing range edges

We can plot how the range edges change over time:

```{r plot-custom-edges, fig.width=7, fig.asp=0.5}
ggplot(edges, aes(year, est, colour = as.factor(quantile))) +
  geom_line(linewidth = 1) +
  geom_ribbon(
    aes(ymin = lwr, ymax = upr, fill = as.factor(quantile)),
    alpha = 0.2,
    colour = NA
  ) +
  labs(
    x = "Year",
    y = "Latitude (UTM km)",
    colour = "Quantile",
    fill = "Quantile"
  ) +
  scale_colour_discrete(labels = c("5%", "50%", "95%")) +
  scale_fill_discrete(labels = c("5%", "50%", "95%")) +
  theme_light()
```

This plot shows how the northern and southern range edges of dogfish have shifted over time, with uncertainty bands reflecting sampling and estimation uncertainty. The median line represents the center of the distribution.

# Accessing simulation draws

For custom analyses, you can access the raw simulation draws:

```{r sims}
edges_sims <- get_range_edge(pred, axis = nd$Y, return_sims = TRUE)
head(edges_sims)
```

This returns all simulation draws in long format, which can be useful for:

- Custom uncertainty quantification
- Calculating probabilities of range shifts
- Comparing range edges between models or scenarios

For example, we could calculate the probability that the upper range edge (northern edge) has shifted northward between two time periods:

```{r prob-shift}
# Extract simulations for upper edge in first and last year
upper_first <- edges_sims |>
  filter(quantile == 0.975, year == min(year))

upper_last <- edges_sims |>
  filter(quantile == 0.975, year == max(year))

# Calculate shift for each simulation
shifts <- upper_last$.value - upper_first$.value[match(upper_last$.iteration, upper_first$.iteration)]

# Probability of northward shift
prob_north <- mean(shifts > 0)
cat("Probability of northward shift:", round(prob_north * 100, 1), "%\n")
```

We can plot that distibution:

```{r prob-shift-hist}
ggplot(data.frame(shifts = shifts), aes(shifts)) + geom_histogram()
```

If anything, the northern range has contracted here, which is consistent with previous research on this stock (Ward et al. 2024).

# Other axes

While we've demonstrated using latitude (Y), range edges can be calculated along any spatial axis. Common choices include:

- **Longitude (X)**: for east-west range shifts
- **Depth**: for depth range edges (e.g., shallow vs. deep distribution limits)
- **Coastal distance**: for offshore/onshore distribution patterns
- **Temperature**: if you have environmental covariates in your prediction grid

Simply provide the appropriate vector to the `axis` argument.

# References

Dunic, J.C., Conner, J., Anderson, S.C., and Thorson, J.T. 2025. The generalized gamma is a flexible distribution that outperforms alternatives when modelling catch rate data. ICES Journal of Marine Science 82(4): fsaf040. <https://doi.org/10.1093/icesjms/fsaf040>

Fredston, A. L., Pinsky, M., Selden, R. L., Szuwalski, C., Thorson, J. T., Gaines, S. D., & Halpern, B. S. (2021). Range edges of North American marine species are tracking temperature over decades. *Global Change Biology*, 27(13), 3145-3156. <https://doi.org/10.1111/gcb.15614>

Ward, E.J., Anderson, S.C., Barnett, L.A.K., English, P.A., Berger, H.M., Commander, C.J.C., Essington, T.E., Harvey, C.J., Hunsicker, M.E., Jacox, M.G., Johnson, K.F., Large, S., Liu, O.R., Richerson, K.E., Samhouri, J.F., Siedlecki, S.A., Shelton, A.O., Somers, K.A., and Watson, J.T. 2024. Win, lose, or draw: Evaluating dynamic thermal niches of northeast Pacific groundfish. PLOS Climate 3(11): e0000454. Public Library of Science. <https://doi.org/10.1371/journal.pclm.0000454>
